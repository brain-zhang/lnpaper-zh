
## 5. Key Storage

## 5. 密钥存储

Keys are generated using BIP 0032 Hierarchical Deterministic Wallets[17]. Keys are pre-generated by both parties. Keys are generated in a merkle tree and are very deep within the tree. For instance, Alice pre-generates one million keys, each key being a child of the previous key. Alice allocates which keys to use according to some deterministic manner. For example, she starts with the child deepest in the tree to generate many sub-keys for day 1.  This key is used as a master key for all keys generated on day 1.  She gives Bob the address she wishes to use for the next transaction, and discloses the private key to Bob when it becomes invalidated. When Alice discloses to Bob all private keys derived from the day 1 master key and does not wish to continue using that master key, she can disclose the day 1 master key to Bob. At this point, Bob does not need to store all the keys derived from the day 1 master key. Bob does the same for Alice and gives her his day 1 key.

> 密钥是使用 BIP 0032 分层确定性钱包[17]生成的。密钥是通过双方预先生成的。这些密钥通过一种叫做默克尔树的技术生成，每个新的密钥都基于前一个。例如，Alice 预生成百万个密钥，每个密钥是前一个密钥的子密钥。Alice会根据一些确定的方式分配使用哪个密钥。例如，比如，她可能会选用最底层的密钥作为第一天使用的主密钥，从它衍生出更多子密钥。她将希望使用的下一个交易地址发给Bob，并在私钥失效时公开给 Bob。当 Alice 向 Bob 公开了由主密钥派生的所有私钥，并且不希望继续使用该主密钥时，她可以把第一天的主密钥透露给Bob。在这一点上，Bob 不需要存储所有由主密钥产生的密钥。Bob 也可以做同样的操作，给 Alice他第1天的主密钥。

When all Day 2 private keys have been exchanged, for example by day 5, Alice discloses her Day 2 key. Bob is able to generate the Day 1 key from the Day 2 key, as the Day 1 key is a child of the Day 2 key as well.

> 当交换了第1天的私钥时，例如在第5天，Alice 公布了她第2天的主密钥。Bob就能够从第2天的主密钥得到第1天的主密钥，因为第1天主密钥也是第2天的主密钥的子密钥。

If a counterparty broadcasts the wrong Commitment Transaction, which private key to use in a transaction to recover funds can either be brute forced, or if both parties agree, they can use the sequence id number when creating the transaction to identify which sets of keys are used.

> 如果交易对方错误地进行了承诺交易的广播，用于交易中回收资金的私钥可以通过尝试所有可能的方式来确定，也就是所谓的暴力破解。或者，如果双方都同意的话，他们可以通过查看交易时生成的序列号来识别应该使用哪一组密钥。这种序列号就像是每笔交易的独特身份标识，有助于区分和确认使用哪些密钥。

This enables participants in a channel to have prior output states (transactions) invalidated by both parties without using much data at all. By disclosing private keys pre-arranged in a merkle-tree, it is possible to invalidate millions of old transactions with only a few kilobytes of data per channel. Core channels in the Lightning Network can conduct billions of transactions without a need for significant storage costs.

> 这一机制使得通道中的参与者可以在几乎不产生任何数据量的情况下，双方协商废弃之前的交易输出状态。通过公开在一种叫做默克尔树（merkle-tree）的数据结构中预设的私钥，可以只用每个通道几KB的数据量，就废除数百万条旧交易。在闪电网络（Lightning Network）的核心通道中，可以进行数十亿次交易，而无需承担巨大的存储成本。
